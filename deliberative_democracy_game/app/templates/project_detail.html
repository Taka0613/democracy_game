{% extends "base.html" %}
{% block title %}Project Detail{% endblock %}
{% block content %}
<h2>{{ project.name }}</h2>
<p><strong>Description:</strong> {{ project.description }}</p>
<p><strong>Required Resources:</strong> {{ project.required_resources }}</p>
<p><strong>Outcomes:</strong> {{ project.outcomes }}</p>

<form method="POST">
    <h3>Contribute Resources</h3>
    {% for user in users %}
    <div class="user-box">
        <h4>{{ user.character_name }}</h4>

        {% if user.id == current_user.id %}
        <p><strong>Current Resources:</strong></p>
        <ul>
            {% set user_resources = user.resources|groupby('type') %}
            {% for resource_type, resources in user_resources %}
            <li>{{ resource_type }}: {{ resources[0].amount }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        <!-- Contribution Input Fields -->
        <label>Contribute Labor (Max {{ user.resources | selectattr('type', 'equalto', 'Labor') |
            map(attribute='amount') | sum }}):</label>
        <input type="number" name="contribute_labor_{{ user.id }}" min="0" value="0"><br>

        <label>Contribute Money (Max {{ user.resources | selectattr('type', 'equalto', 'Money') |
            map(attribute='amount') | sum }}):</label>
        <input type="number" name="contribute_money_{{ user.id }}" min="0" value="0"><br>

        <label>Contribute Time (Max {{ user.resources | selectattr('type', 'equalto', 'Time') |
            map(attribute='amount') | sum }}):</label>
        <input type="number" name="contribute_time_{{ user.id }}" min="0" value="0"><br>

        <!-- Insights Input Field -->
        <label>Policy Insight/Feedback:</label><br>
        <textarea name="policy_insight_{{ user.id }}" rows="4" cols="50"
            placeholder="Write your insights or suggested modifications about the policy...">{{ user_insights[user.id] if user_insights else '' }}</textarea><br>
    </div>
    {% endfor %}

    <!-- Majority Vote Checkboxes -->
    <h3>Requirements</h3>
    <input type="checkbox" id="majority-vote" name="majority_vote" onclick="checkSubmitButton()">
    <label for="majority-vote">Achieved majority vote</label><br>

    <input type="checkbox" id="revised-policy-vote" name="revised_policy_vote" onclick="checkSubmitButton()">
    <label for="revised-policy-vote">Revised policy achieved majority vote</label><br>

    <button type="submit" id="submit-button" disabled>Submit Contribution and Feedback</button>
</form>

<script>
    function checkSubmitButton() {
        const majorityVote = document.getElementById('majority-vote').checked;
        const revisedPolicyVote = document.getElementById('revised-policy-vote').checked;
        document.getElementById('submit-button').disabled = !(majorityVote || revisedPolicyVote);
    }
</script>
{% endblock %}